/**
 * Copyright (c) 2010 The Chromium Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style license that can be found
 * in the LICENSE file.
 */
function ChromeExOAuth(a,b,c,d,e,f,g){this.url_request_token=a;this.url_auth_token=b;this.url_access_token=c;this.consumer_key=d;this.consumer_secret=e;this.oauth_scope=f;this.app_name=g&&g["app_name"]||"ChromeExOAuth Library";this.key_token="oauth_token";this.key_token_secret="oauth_token_secret";this.callback_page=g&&g["callback_page"]||"pages/chrome_ex_oauth.html";this.auth_params={};if(g&&g["auth_params"]){for(key in g["auth_params"]){if(g["auth_params"].hasOwnProperty(key)){this.auth_params[key]=g["auth_params"][key]}}}}ChromeExOAuth.initBackgroundPage=function(a){window.chromeExOAuthConfig=a;window.chromeExOAuth=ChromeExOAuth.fromConfig(a);window.chromeExOAuthRedirectStarted=false;window.chromeExOAuthRequestingAccess=false;var b=chrome.extension.getURL(window.chromeExOAuth.callback_page);var c={};chrome.tabs.onUpdated.addListener(function(a,d,e){if(d.url&&d.url.substr(0,b.length)===b&&d.url!=c[a]&&window.chromeExOAuthRequestingAccess==false){chrome.tabs.create({url:d.url},function(b){c[b.id]=b.url;chrome.tabs.remove(a)})}});return window.chromeExOAuth};ChromeExOAuth.prototype.authorize=function(a){if(this.hasToken()){a(this.getToken(),this.getTokenSecret())}else{window.chromeExOAuthOnAuthorize=function(b,c){a(b,c)};chrome.tabs.create({url:chrome.extension.getURL(this.callback_page)})}};ChromeExOAuth.prototype.clearTokens=function(){delete localStorage[this.key_token+encodeURI(this.oauth_scope)];delete localStorage[this.key_token_secret+encodeURI(this.oauth_scope)]};ChromeExOAuth.prototype.hasToken=function(){return!!this.getToken()};ChromeExOAuth.prototype.sendSignedRequest=function(a,b,c){var d=c&&c["method"]||"GET";var e=c&&c["body"]||null;var f=c&&c["parameters"]||{};var g=c&&c["headers"]||{};var h=this.signURL(a,d,f);ChromeExOAuth.sendRequest(d,h,g,e,function(a){if(a.readyState==4){b(a.responseText,a)}})};ChromeExOAuth.prototype.signURL=function(a,b,c){var d=this.getToken();var e=this.getTokenSecret();if(!d||!e){throw new Error("No oauth token or token secret")}var f=c||{};var g=OAuthSimple().sign({action:b,path:a,parameters:f,signatures:{consumer_key:this.consumer_key,shared_secret:this.consumer_secret,oauth_secret:e,oauth_token:d}});return g.signed_url};ChromeExOAuth.prototype.getAuthorizationHeader=function(a,b,c){var d=this.getToken();var e=this.getTokenSecret();if(!d||!e){throw new Error("No oauth token or token secret")}var f=c||{};return OAuthSimple().getHeaderString({action:b,path:a,parameters:f,signatures:{consumer_key:this.consumer_key,shared_secret:this.consumer_secret,oauth_secret:e,oauth_token:d}})};ChromeExOAuth.fromConfig=function(a){return new ChromeExOAuth(a["request_url"],a["authorize_url"],a["access_url"],a["consumer_key"],a["consumer_secret"],a["scope"],{app_name:a["app_name"],auth_params:a["auth_params"]})};ChromeExOAuth.initCallbackPage=function(){var a=chrome.extension.getBackgroundPage();var b=a.chromeExOAuthConfig;var c=ChromeExOAuth.fromConfig(b);a.chromeExOAuthRedirectStarted=true;c.initOAuthFlow(function(b,c){a.chromeExOAuthOnAuthorize(b,c);a.chromeExOAuthRedirectStarted=false;chrome.tabs.getSelected(null,function(a){chrome.tabs.remove(a.id)})})};ChromeExOAuth.sendRequest=function(a,b,c,d,e){var f=new XMLHttpRequest;f.onreadystatechange=function(a){e(f,a)};f.open(a,b,true);if(c){for(var g in c){if(c.hasOwnProperty(g)){f.setRequestHeader(g,c[g])}}}f.send(d)};ChromeExOAuth.formDecode=function(a){var b=a.split("&");var c={};for(var d=0,e;e=b[d];d++){var f=e.split("=");if(f.length==2){var g=ChromeExOAuth.fromRfc3986(f[0]);var h=ChromeExOAuth.fromRfc3986(f[1]);c[g]=h}}return c};ChromeExOAuth.getQueryStringParams=function(){var a=window.location.href.split("?");if(a.length>=2){var b=a.slice(1).join("?");return ChromeExOAuth.formDecode(b)}return{}};ChromeExOAuth.bind=function(a,b){var c=Array.prototype.slice.call(arguments).slice(2);return function(){var d=c.concat(Array.prototype.slice.call(arguments));a.apply(b,d)}};ChromeExOAuth.toRfc3986=function(a){return encodeURIComponent(a).replace(/\!/g,"%21").replace(/\*/g,"%2A").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29")};ChromeExOAuth.fromRfc3986=function(a){var b=a.replace(/%21/g,"!").replace(/%2A/g,"*").replace(/%27/g,"'").replace(/%28/g,"(").replace(/%29/g,")");return decodeURIComponent(b)};ChromeExOAuth.addURLParam=function(a,b,c){var d=a.indexOf("?")>=0?"&":"?";return a+d+ChromeExOAuth.toRfc3986(b)+"="+ChromeExOAuth.toRfc3986(c)};ChromeExOAuth.prototype.setToken=function(a){localStorage[this.key_token+encodeURI(this.oauth_scope)]=a};ChromeExOAuth.prototype.getToken=function(){return localStorage[this.key_token+encodeURI(this.oauth_scope)]};ChromeExOAuth.prototype.setTokenSecret=function(a){localStorage[this.key_token_secret+encodeURI(this.oauth_scope)]=a};ChromeExOAuth.prototype.getTokenSecret=function(){return localStorage[this.key_token_secret+encodeURI(this.oauth_scope)]};ChromeExOAuth.prototype.initOAuthFlow=function(a){if(!this.hasToken()){var b=ChromeExOAuth.getQueryStringParams();if(b["chromeexoauthcallback"]=="true"){var c=b["oauth_token"];var d=b["oauth_verifier"];this.getAccessToken(c,d,a)}else{var e={url_callback_param:"chromeexoauthcallback"};this.getRequestToken(function(a){window.location.href=a},e)}}else{a(this.getToken(),this.getTokenSecret())}};ChromeExOAuth.prototype.getRequestToken=function(a,b){if(typeof a!=="function"){throw new Error("Specified callback must be a function.")}var c=b&&b["url_callback"]||window&&window.top&&window.top.location&&window.top.location.href;var d=b&&b["url_callback_param"]||"chromeexoauthcallback";var e=ChromeExOAuth.addURLParam(c,d,"true");var f=OAuthSimple().sign({path:this.url_request_token,parameters:{xoauth_displayname:this.app_name,scope:this.oauth_scope,oauth_callback:e},signatures:{consumer_key:this.consumer_key,shared_secret:this.consumer_secret}});var g=ChromeExOAuth.bind(this.onRequestToken,this,a);ChromeExOAuth.sendRequest("GET",f.signed_url,null,null,g)};ChromeExOAuth.prototype.onRequestToken=function(a,b){if(b.readyState==4){if(b.status==200){var c=ChromeExOAuth.formDecode(b.responseText);var d=c["oauth_token"];this.setTokenSecret(c["oauth_token_secret"]);var e=ChromeExOAuth.addURLParam(this.url_auth_token,"oauth_token",d);for(var f in this.auth_params){if(this.auth_params.hasOwnProperty(f)){e=ChromeExOAuth.addURLParam(e,f,this.auth_params[f])}}a(e)}else{throw new Error("Fetching request token failed. Status "+b.status)}}};ChromeExOAuth.prototype.getAccessToken=function(a,b,c){if(typeof c!=="function"){throw new Error("Specified callback must be a function.")}var d=chrome.extension.getBackgroundPage();if(d.chromeExOAuthRequestingAccess==false){d.chromeExOAuthRequestingAccess=true;var e=OAuthSimple().sign({path:this.url_access_token,parameters:{oauth_token:a,oauth_verifier:b},signatures:{consumer_key:this.consumer_key,shared_secret:this.consumer_secret,oauth_secret:this.getTokenSecret(this.oauth_scope)}});var f=ChromeExOAuth.bind(this.onAccessToken,this,c);ChromeExOAuth.sendRequest("GET",e.signed_url,null,null,f)}};ChromeExOAuth.prototype.onAccessToken=function(a,b){if(b.readyState==4){var c=chrome.extension.getBackgroundPage();if(b.status==200){var d=ChromeExOAuth.formDecode(b.responseText);var e=d["oauth_token"];var f=d["oauth_token_secret"];this.setToken(e);this.setTokenSecret(f);c.chromeExOAuthRequestingAccess=false;a(e,f)}else{c.chromeExOAuthRequestingAccess=false;throw new Error("Fetching access token failed with status "+b.status)}}}