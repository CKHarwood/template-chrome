<!DOCTYPE html>  <html> <head>   <title>background.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="background.html">                 background.coffee               </a>                                           <a class="source" href="content.html">                 content.coffee               </a>                                           <a class="source" href="install.html">                 install.coffee               </a>                                           <a class="source" href="notification.html">                 notification.coffee               </a>                                           <a class="source" href="options.html">                 options.coffee               </a>                                           <a class="source" href="popup.html">                 popup.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               background.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><a href="http://neocotic.com/template">Template</a> <br />
(c) 2012 Alasdair Mercer <br />
Freely distributable under the MIT license. <br />
For all details and documentation: <br />
<a href="http://neocotic.com/template">http://neocotic.com/template</a></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Private constants</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>List of blacklisted extension IDs that should be prevented from making
external requests to Template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">BLACKLIST         = </span><span class="p">[]</span>
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Default features to be used by Template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">DEFAULT_FEATURES  = </span><span class="p">[</span>
    <span class="nv">content: </span> <span class="s2">&quot;&lt;a href=\&quot;{{url}}\&quot;{#doAnchorTarget}</span>
<span class="s2"> target=\&quot;_blank\&quot;{/doAnchorTarget}{#doAnchorTitle}</span>
<span class="s2"> title=\&quot;{{title}}\&quot;{/doAnchorTitle}&gt;{{title}}&lt;/a&gt;&quot;</span>
    <span class="nv">enabled: </span> <span class="kc">yes</span>
    <span class="nv">image: </span>   <span class="mi">11</span>
    <span class="nv">index: </span>   <span class="mi">2</span>
    <span class="nv">name: </span>    <span class="s1">&#39;_anchor&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;A&#39;</span>
    <span class="nv">title: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;copy_anchor&#39;</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s1">&#39;[url={url}]{title}[/url]&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">no</span>
    <span class="nv">image: </span>   <span class="mi">7</span>
    <span class="nv">index: </span>   <span class="mi">5</span>
    <span class="nv">name: </span>    <span class="s1">&#39;_bbcode&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;B&#39;</span>
    <span class="nv">title: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;copy_bbcode&#39;</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s1">&#39;{#encode}{url}{/encode}&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">yes</span>
    <span class="nv">image: </span>   <span class="mi">5</span>
    <span class="nv">index: </span>   <span class="mi">3</span>
    <span class="nv">name: </span>    <span class="s1">&#39;_encoded&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;E&#39;</span>
    <span class="nv">title: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;copy_encoded&#39;</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s1">&#39;[{title}]({url})&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">no</span>
    <span class="nv">image: </span>   <span class="mi">7</span>
    <span class="nv">index: </span>   <span class="mi">4</span>
    <span class="nv">name: </span>    <span class="s1">&#39;_markdown&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;M&#39;</span>
    <span class="nv">title: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;copy_markdown&#39;</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s1">&#39;{short}&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">yes</span>
    <span class="nv">image: </span>   <span class="mi">16</span>
    <span class="nv">index: </span>   <span class="mi">1</span>
    <span class="nv">name: </span>    <span class="s1">&#39;_short&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;S&#39;</span>
    <span class="nv">title: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;copy_short&#39;</span>
  <span class="p">,</span>
    <span class="nv">content: </span> <span class="s1">&#39;{url}&#39;</span>
    <span class="nv">enabled: </span> <span class="kc">yes</span>
    <span class="nv">image: </span>   <span class="mi">8</span>
    <span class="nv">index: </span>   <span class="mi">0</span>
    <span class="nv">name: </span>    <span class="s1">&#39;_url&#39;</span>
    <span class="nv">readOnly: </span><span class="kc">yes</span>
    <span class="nv">shortcut: </span><span class="s1">&#39;U&#39;</span>
    <span class="nv">title: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;copy_url&#39;</span>
<span class="p">]</span>
</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Domain of this extension's homepage.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">HOMEPAGE_DOMAIN   = </span><span class="s1">&#39;neocotic.com&#39;</span>
</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>List of known operating systems that could be used by the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">OPERATING_SYSTEMS = </span><span class="p">[</span>
  <span class="nv">substring: </span><span class="s1">&#39;Win&#39;</span>
  <span class="nv">title: </span>    <span class="s1">&#39;Windows&#39;</span>
<span class="p">,</span>
  <span class="nv">substring: </span><span class="s1">&#39;Mac&#39;</span>
  <span class="nv">title: </span>    <span class="s1">&#39;Mac&#39;</span>
<span class="p">,</span>
  <span class="nv">substring: </span><span class="s1">&#39;Linux&#39;</span>
  <span class="nv">title: </span>    <span class="s1">&#39;Linux&#39;</span>
<span class="p">]</span>
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>List of URL shortener services supported by Template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">SHORTENERS        = </span><span class="p">[</span>
</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Setup <a href="http://bit.ly">bitly</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">contentType: </span><span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>
  <span class="nv">getParameters: </span><span class="nf">(url) -&gt;</span>
</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>TODO: Create a new account and eliminate used of <code>forchoon</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">params =</span>
      <span class="nv">apiKey: </span> <span class="s1">&#39;R_2371fda46305d0ec3065972f5e72800e&#39;</span>
      <span class="nv">format: </span> <span class="s1">&#39;json&#39;</span>
      <span class="nv">login: </span>  <span class="s1">&#39;forchoon&#39;</span>
      <span class="nv">longUrl: </span><span class="nx">url</span>
    <span class="k">if</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;bitlyApiKey&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitlyUsername&#39;</span>
      <span class="nv">params.x_apiKey = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitlyApiKey&#39;</span>
      <span class="nv">params.x_login  = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitlyUsername&#39;</span>
    <span class="nx">params</span>
  <span class="nv">input: </span><span class="o">-&gt;</span>
    <span class="kc">null</span>
  <span class="nv">isEnabled: </span><span class="o">-&gt;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitly&#39;</span>
  <span class="nv">method: </span><span class="s1">&#39;GET&#39;</span>
  <span class="nv">name: </span><span class="s1">&#39;bit.ly&#39;</span>
  <span class="nv">output: </span><span class="nf">(resp) -&gt;</span>
    <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">).</span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span>
  <span class="nv">url: </span><span class="o">-&gt;</span>
    <span class="s1">&#39;http://api.bitly.com/v3/shorten&#39;</span>
<span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Setup <a href="http://goo.gl">Google URL Shortener</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">contentType: </span><span class="s1">&#39;application/json&#39;</span>
  <span class="nv">getParameters: </span><span class="o">-&gt;</span>
    <span class="nv">key: </span><span class="s1">&#39;AIzaSyD504IwHeL3V2aw6ZGYQRgwWnJ38jNl2MY&#39;</span>
  <span class="nv">input: </span><span class="nf">(url) -&gt;</span>
    <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nv">longUrl: </span><span class="nx">url</span>
  <span class="nv">isEnabled: </span><span class="o">-&gt;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;googl&#39;</span>
  <span class="nv">isOAuthEnabled: </span><span class="o">-&gt;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;googlOAuth&#39;</span>
  <span class="nv">method: </span><span class="s1">&#39;POST&#39;</span>
  <span class="nv">name: </span><span class="s1">&#39;goo.gl&#39;</span>
  <span class="nv">oauth: </span><span class="nx">ChromeExOAuth</span><span class="p">.</span><span class="nx">initBackgroundPage</span>
    <span class="nv">access_url: </span>     <span class="s1">&#39;https://www.google.com/accounts/OAuthGetAccessToken&#39;</span>
    <span class="nv">app_name: </span>       <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;app_name&#39;</span>
    <span class="nv">authorize_url: </span>  <span class="s1">&#39;https://www.google.com/accounts/OAuthAuthorizeToken&#39;</span>
    <span class="nv">consumer_key: </span>   <span class="s1">&#39;anonymous&#39;</span>
    <span class="nv">consumer_secret: </span><span class="s1">&#39;anonymous&#39;</span>
    <span class="nv">request_url: </span>    <span class="s1">&#39;https://www.google.com/accounts/OAuthGetRequestToken&#39;</span>
    <span class="nv">scope: </span>          <span class="s1">&#39;https://www.googleapis.com/auth/urlshortener&#39;</span>
  <span class="nv">output: </span><span class="nf">(resp) -&gt;</span>
    <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">).</span><span class="nx">id</span>
  <span class="nv">url: </span><span class="o">-&gt;</span>
    <span class="s1">&#39;https://www.googleapis.com/urlshortener/v1/url&#39;</span>
<span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Setup <a href="http://yourls.org">YOURLS</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">contentType: </span><span class="s1">&#39;application/json&#39;</span>
  <span class="nv">getParameters: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">params =</span>
      <span class="nv">action: </span><span class="s1">&#39;shorturl&#39;</span>
      <span class="nv">format: </span><span class="s1">&#39;json&#39;</span>
      <span class="nv">url: </span>   <span class="nx">url</span>
    <span class="k">if</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;yourlsPassword&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsUsername&#39;</span>
      <span class="nv">params.password  = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsPassword&#39;</span>
      <span class="nv">params.username  = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsUsername&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsSignature&#39;</span>
      <span class="nv">params.signature = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsSignature&#39;</span>
    <span class="nx">params</span>
  <span class="nv">input: </span><span class="o">-&gt;</span>
    <span class="kc">null</span>
  <span class="nv">isEnabled: </span><span class="o">-&gt;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourls&#39;</span>
  <span class="nv">method: </span><span class="s1">&#39;POST&#39;</span>
  <span class="nv">name: </span><span class="s1">&#39;YOURLS&#39;</span>
  <span class="nv">output: </span><span class="nf">(resp) -&gt;</span>
    <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">resp</span><span class="p">).</span><span class="nx">shorturl</span>
  <span class="nv">url: </span><span class="o">-&gt;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsUrl&#39;</span>
<span class="p">]</span>
</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>List of extensions supported by Template and used for compatibility purposes.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">SUPPORT           = </span><span class="p">[</span>
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Setup <a href="http://ietab.net">IE Tab</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">id: </span><span class="s1">&#39;hehijbfgiekmjfkfjpbkbammjbdenadd&#39;</span>
  <span class="nv">title: </span><span class="nf">(title) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;IE: &#39;</span>
    <span class="k">if</span> <span class="nx">title</span>
      <span class="nv">idx = </span><span class="nx">title</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="k">return</span> <span class="nx">title</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="nx">title</span>
  <span class="nv">url: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;iecontainer.html#url=&#39;</span>
    <span class="k">if</span> <span class="nx">url</span>
      <span class="nv">idx = </span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="k">return</span> <span class="nb">decodeURIComponent</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="nx">url</span>
<span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Setup <a href="http://goo.gl/u7Cau">IE Tab Classic</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">id: </span><span class="s1">&#39;miedgcmlgpmdagojnnbemlkgidepfjfi&#39;</span>
  <span class="nv">title: </span><span class="nf">(title) -&gt;</span>
    <span class="nx">title</span>
  <span class="nv">url: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;ie.html#&#39;</span>
    <span class="k">if</span> <span class="nx">url</span>
      <span class="nv">idx = </span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="k">return</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span> <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="nx">url</span>
<span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Setup <a href="http://iblogbox.com/chrome/ietab">IE Tab Multi (Enhance)</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">id: </span><span class="s1">&#39;fnfnbeppfinmnjnjhedifcfllpcfgeea&#39;</span>
  <span class="nv">title: </span><span class="nf">(title) -&gt;</span>
    <span class="nx">title</span>
  <span class="nv">url: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;navigate.html?chromeurl=&#39;</span>
    <span class="k">if</span> <span class="nx">url</span>
      <span class="nv">idx = </span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">url = </span><span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">str = </span><span class="s1">&#39;[escape]&#39;</span>
        <span class="k">if</span> <span class="nx">url</span> <span class="o">and</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nv">url = </span><span class="nb">decodeURIComponent</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span>
        <span class="k">return</span> <span class="nx">url</span>
    <span class="k">return</span> <span class="nx">url</span>
<span class="p">,</span>
</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Setup <a href="http://iblogbox.com/chrome/geckotab">Mozilla Gecko Tab</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">id: </span><span class="s1">&#39;icoloanbecehinobmflpeglknkplbfbm&#39;</span>
  <span class="nv">title: </span><span class="nf">(title) -&gt;</span>
    <span class="nx">title</span>
  <span class="nv">url: </span><span class="nf">(url) -&gt;</span>
    <span class="nv">str = </span><span class="s1">&#39;navigate.html?chromeurl=&#39;</span>
    <span class="k">if</span> <span class="nx">url</span>
      <span class="nv">idx = </span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">str</span>
      <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">url = </span><span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span>
        <span class="nv">str = </span><span class="s1">&#39;[escape]&#39;</span>
        <span class="k">if</span> <span class="nx">url</span> <span class="o">and</span> <span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nv">url = </span><span class="nb">decodeURIComponent</span> <span class="nx">url</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span>
        <span class="k">return</span> <span class="nx">url</span>
    <span class="k">return</span> <span class="nx">url</span>
<span class="p">]</span>

</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>Private variables</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Details of the current browser.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">browser         =</span>
  <span class="nv">title: </span>  <span class="s1">&#39;Chrome&#39;</span>
  <span class="nv">version: </span><span class="s1">&#39;&#39;</span>
</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Name of the user's operating system.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">operatingSystem = </span><span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Private functions</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Add the feature <code>name</code> to the list stored in <code>localStorage</code>. <br />
<code>name</code> will only be added if it doesn't already exist.  </p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">addFeatureName = </span><span class="nf">(name) -&gt;</span>
  <span class="nv">features = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;features&#39;</span>
  <span class="k">if</span> <span class="nx">features</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nx">features</span><span class="p">.</span><span class="nx">push</span> <span class="nx">name</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="nx">features</span>
    <span class="k">return</span> <span class="kc">yes</span>
  <span class="kc">no</span>

</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Delete the stored values for the feature with the specified <code>name</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">deleteFeature = </span><span class="nf">(name) -&gt;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">remove</span> <span class="s2">&quot;feat_#{name}_content&quot;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">remove</span> <span class="s2">&quot;feat_#{name}_enabled&quot;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">remove</span> <span class="s2">&quot;feat_#{name}_image&quot;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">remove</span> <span class="s2">&quot;feat_#{name}_index&quot;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">remove</span> <span class="s2">&quot;feat_#{name}_readonly&quot;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">remove</span> <span class="s2">&quot;feat_#{name}_shortcut&quot;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">remove</span> <span class="s2">&quot;feat_#{name}_title&quot;</span>

</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Inject and execute the <code>content.coffee</code> and <code>install.coffee</code> scripts within
all of the tabs (where valid) of each Chrome window.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">executeScriptsInExistingWindows = </span><span class="o">-&gt;</span>
  <span class="nx">chrome</span><span class="p">.</span><span class="nx">windows</span><span class="p">.</span><span class="nx">getAll</span> <span class="kc">null</span><span class="p">,</span> <span class="nf">(windows) -&gt;</span>
    <span class="k">for</span> <span class="nx">win</span> <span class="k">in</span> <span class="nx">windows</span>
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Retrieve all tabs open in <code>win</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">query</span> <span class="nv">windowId: </span><span class="nx">win</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nf">(tabs) -&gt;</span>
</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Check tabs are not displaying a <em>protected</em> page (i.e. one that will
cause an error if an attempt is made to execute content scripts).</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">for</span> <span class="nx">tab</span> <span class="k">in</span> <span class="nx">tabs</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">isProtectedPage</span> <span class="nx">tab</span>
          <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">executeScript</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nv">file: </span><span class="s1">&#39;lib/content.js&#39;</span>
</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Only execute inline installation content script for tabs displaying
a page on Template's homepage domain.</p>             </td>             <td class="code">               <div class="highlight"><pre>
          <span class="k">if</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">HOMEPAGE_DOMAIN</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
            <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">executeScript</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nv">file: </span><span class="s1">&#39;lib/install.js&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Attempt to derive the current version of the user's browser.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getBrowserVersion = </span><span class="o">-&gt;</span>
  <span class="nv">str = </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span>
  <span class="nv">idx = </span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">title</span>
  <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nv">str = </span><span class="nx">str</span><span class="p">.</span><span class="nx">substring</span> <span class="nx">idx</span> <span class="o">+</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="nv">idx = </span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s1">&#39; &#39;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">idx</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">str</span> <span class="k">else</span> <span class="nx">str</span><span class="p">.</span><span class="nx">substring</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">idx</span>

</pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Attempt to retrieve the feature with the specified <code>menuId</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getFeatureWithMenuId = </span><span class="nf">(menuId) -&gt;</span>
  <span class="nx">queryFeature</span> <span class="nf">(feature) -&gt;</span>
    <span class="nx">feature</span><span class="p">.</span><span class="nx">menuId</span> <span class="o">is</span> <span class="nx">menuId</span>

</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Attempt to retrieve the feature with the specified <code>name</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getFeatureWithName = </span><span class="nf">(name) -&gt;</span>
  <span class="nx">queryFeature</span> <span class="nf">(feature) -&gt;</span>
    <span class="nx">feature</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="nx">name</span>

</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Attempt to retrieve the feature with the specified keyboard <code>shortcut</code>. <br />
Exclude disabled features from this query.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getFeatureWithShortcut = </span><span class="nf">(shortcut) -&gt;</span>
  <span class="nx">queryFeature</span> <span class="nf">(feature) -&gt;</span>
    <span class="nx">feature</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">and</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">shortcut</span> <span class="o">is</span> <span class="nx">shortcut</span>

</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Derive the path of the image used by <code>feature</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getImagePathForFeature = </span><span class="nf">(feature, relative) -&gt;</span>
  <span class="nv">path = </span><span class="s1">&#39;&#39;</span>
  <span class="k">for</span> <span class="nx">image</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">IMAGES</span> <span class="k">when</span> <span class="nx">image</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">image</span>
    <span class="nx">path</span> <span class="o">+=</span> <span class="s1">&#39;../&#39;</span> <span class="k">if</span> <span class="nx">relative</span>
    <span class="nx">path</span> <span class="o">+=</span> <span class="s2">&quot;images/#{image.file}&quot;</span>
    <span class="k">break</span>
  <span class="nx">path</span>

</pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Derive the operating system being used by the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getOperatingSystem = </span><span class="o">-&gt;</span>
  <span class="nv">str = </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">platform</span>
  <span class="k">for</span> <span class="nx">os</span> <span class="k">in</span> <span class="nx">OPERATING_SYSTEMS</span> <span class="k">when</span> <span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">substring</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nv">str = </span><span class="nx">os</span><span class="p">.</span><span class="nx">title</span>
    <span class="k">break</span>
  <span class="nx">str</span>

</pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Determine whether or not <code>sender</code> is a blacklisted extension.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isBlacklisted = </span><span class="nf">(sender) -&gt;</span>
  <span class="k">return</span> <span class="kc">yes</span> <span class="k">for</span> <span class="nx">extension</span> <span class="k">in</span> <span class="nx">BLACKLIST</span> <span class="k">when</span> <span class="nx">extension</span> <span class="o">is</span> <span class="nx">sender</span><span class="p">.</span><span class="nx">id</span>
  <span class="kc">no</span>

</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Determine whether or not the specified extension is active on <code>tab</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isExtensionActive = </span><span class="nf">(tab, extensionId) -&gt;</span>
  <span class="nx">isSpecialPage</span><span class="p">(</span><span class="nx">tab</span><span class="p">)</span> <span class="o">and</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">extensionId</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>

</pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Determine whether or not <code>tab</code> is currently displaying a page on the Chrome
Extension Gallery (i.e. Web Store).</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isExtensionGallery = </span><span class="nf">(tab) -&gt;</span>
  <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;https://chrome.google.com/webstore&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>

</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Determine whether or not <code>tab</code> is currently displaying a <em>protected</em> page
(i.e. a page that content scripts cannot be executed on).</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isProtectedPage = </span><span class="nf">(tab) -&gt;</span>
  <span class="nx">isSpecialPage</span><span class="p">(</span><span class="nx">tab</span><span class="p">)</span> <span class="o">or</span> <span class="nx">isExtensionGallery</span> <span class="nx">tab</span>

</pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Determine whether or not <code>tab</code> is currently displaying a <em>special</em> page (i.e.
a page that is internal to the browser).</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">isSpecialPage = </span><span class="nf">(tab) -&gt;</span>
  <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;chrome&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>

</pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Load the settings for the derived feature.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">loadFeature = </span><span class="nf">(name) -&gt;</span>
  <span class="nv">content: </span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;feat_#{name}_content&quot;</span>
  <span class="nv">enabled: </span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;feat_#{name}_enabled&quot;</span>
  <span class="nv">image: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;feat_#{name}_image&quot;</span>
  <span class="nv">index: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;feat_#{name}_index&quot;</span>
  <span class="nv">name: </span>    <span class="nx">name</span>
  <span class="nv">readOnly: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;feat_#{name}_readonly&quot;</span>
  <span class="nv">shortcut: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;feat_#{name}_shortcut&quot;</span>
  <span class="nv">title: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;feat_#{name}_title&quot;</span>

</pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Load the settings for all persisted features. <br />
Sort the features based on their index.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">loadFeatures = </span><span class="o">-&gt;</span>
  <span class="nv">features = </span><span class="p">[]</span>
  <span class="nv">names = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;features&#39;</span>
  <span class="nx">features</span><span class="p">.</span><span class="nx">push</span> <span class="nx">loadFeature</span> <span class="nx">name</span> <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">names</span>
  <span class="nx">features</span><span class="p">.</span><span class="nx">sort</span> <span class="nf">(a, b) -&gt;</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">index</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">index</span>
  <span class="nx">features</span>

</pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Listener for internal requests to the extension. <br />
External requests are also routed through here, but only after being checked
that they do not originate from a blacklisted extension.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">onRequest = </span><span class="nf">(request, sender, sendResponse) -&gt;</span>
</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Don't allow shortcut requests when shortcuts are disabled.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;shortcut&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortcuts&#39;</span>
    <span class="k">return</span> <span class="nx">sendResponse</span><span class="o">?</span><span class="p">()</span>
</pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Version requests are simple, just send the version back. Done!</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">request</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;version&#39;</span>
    <span class="k">return</span> <span class="nx">sendResponse</span><span class="o">?</span> <span class="nv">version: </span><span class="nx">ext</span><span class="p">.</span><span class="nx">version</span>
  <span class="nx">chrome</span><span class="p">.</span><span class="nx">windows</span><span class="p">.</span><span class="nx">getCurrent</span> <span class="nf">(win) -&gt;</span>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">query</span>
      <span class="nv">active: </span>  <span class="kc">yes</span>
      <span class="nv">windowId: </span><span class="nx">win</span><span class="p">.</span><span class="nx">id</span>
    <span class="p">,</span> <span class="nf">(tabs) -&gt;</span>
      <span class="nv">data             = </span><span class="p">{}</span>
      <span class="nv">popup            = </span><span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">getViews</span><span class="p">(</span><span class="nv">type: </span><span class="s1">&#39;popup&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">shortCalled      = </span><span class="kc">no</span>
      <span class="nv">shortPlaceholder = </span><span class="s2">&quot;short#{Math.floor Math.random() * 99999 + 1000}&quot;</span>
      <span class="nv">tab              = </span><span class="nx">tabs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Attempt to copy <code>str</code> to the system clipboard while handling the
potential for failure.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">copyOutput = </span><span class="nf">(str) -&gt;</span>
        <span class="k">if</span> <span class="nx">str</span>
          <span class="nx">ext</span><span class="p">.</span><span class="nx">copy</span> <span class="nx">str</span>
        <span class="k">else</span>
          <span class="nv">ext.message = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;copy_fail_empty&#39;</span>
          <span class="nv">ext.status  = </span><span class="kc">no</span>
          <span class="nx">showNotification</span><span class="p">()</span>
</pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Called whenever the <code>short</code> tag is found to indicate that the URL
needs shortened. <br />
Replace the <code>short</code> tag with the unique placeholder so that it can be
rendered again later with the short URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">shortCallback = </span><span class="o">-&gt;</span>
        <span class="nv">shortCalled = </span><span class="kc">yes</span>
        <span class="s2">&quot;{#{shortPlaceholder}}&quot;</span>
</pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>If the popup is currently displayed, hide the feature list and show a
loading animation.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">popup</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#item&#39;</span><span class="p">,</span> <span class="nx">popup</span><span class="p">.</span><span class="nb">document</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#loadDiv&#39;</span><span class="p">,</span> <span class="nx">popup</span><span class="p">.</span><span class="nb">document</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
</pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Attempt to derive the contextual template data.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">try</span>
        <span class="k">switch</span> <span class="nx">request</span><span class="p">.</span><span class="nx">type</span>
          <span class="k">when</span> <span class="s1">&#39;menu&#39;</span>
            <span class="nv">data    = </span><span class="nx">buildDerivedData</span> <span class="nx">tab</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">shortCallback</span>
            <span class="nv">feature = </span><span class="nx">getFeatureWithMenuId</span> <span class="nx">request</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">menuItemId</span>
          <span class="k">when</span> <span class="s1">&#39;popup&#39;</span>
            <span class="nv">data    = </span><span class="nx">buildStandardData</span> <span class="nx">tab</span><span class="p">,</span> <span class="nx">shortCallback</span>
</pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Should be cheaper than searching through <code>ext.features</code>...</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nv">feature = </span><span class="nx">loadFeature</span> <span class="nx">request</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span>
          <span class="k">when</span> <span class="s1">&#39;shortcut&#39;</span>
            <span class="nv">data    = </span><span class="nx">buildStandardData</span> <span class="nx">tab</span><span class="p">,</span> <span class="nx">shortCallback</span>
            <span class="nv">feature = </span><span class="nx">getFeatureWithShortcut</span> <span class="nx">request</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">key</span>
      <span class="k">catch</span> <span class="nx">error</span>
</pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Oops! Something went wrong so we should probably let the user know.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="k">if</span> <span class="nx">error</span> <span class="k">instanceof</span> <span class="nx">URIError</span>
          <span class="nv">ext.message = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;copy_fail_uri&#39;</span>
        <span class="k">else</span>
          <span class="nv">ext.message = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;copy_fail_error&#39;</span>
        <span class="nv">ext.status = </span><span class="kc">no</span>
        <span class="nx">showNotification</span><span class="p">()</span>
        <span class="k">return</span>
      <span class="k">if</span> <span class="nx">feature</span>
        <span class="nx">addAdditionalData</span> <span class="nx">tab</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="o">-&gt;</span>
          <span class="nx">unless</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">content</span>
</pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Display the <em>empty template</em> error message.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">copyOutput</span><span class="p">()</span>
            <span class="k">return</span>
          <span class="nv">output = </span><span class="nx">Mustache</span><span class="p">.</span><span class="nx">to_html</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="nx">data</span>
          <span class="k">if</span> <span class="nx">shortCalled</span>
</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>At least one <code>short</code> tag was found and replaced, so now we need
to call the URL shortener service and replace that with the
actual short URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>
            <span class="nx">callUrlShortener</span> <span class="nx">data</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span> <span class="nf">(response) -&gt;</span>
              <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">success</span> <span class="o">and</span> <span class="nx">response</span><span class="p">.</span><span class="nx">shortUrl</span>
</pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Short URL was successfully returned, so get rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nv">newData = </span><span class="p">{}</span>
                <span class="nx">newData</span><span class="p">[</span><span class="nx">shortPlaceholder</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">shortUrl</span>
                <span class="nx">copyOutput</span> <span class="nx">Mustache</span><span class="p">.</span><span class="nx">to_html</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">newData</span>
              <span class="k">else</span>
</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Aw man, something went wrong. Let the user down gently.</p>             </td>             <td class="code">               <div class="highlight"><pre>
                <span class="nx">unless</span> <span class="nx">response</span><span class="p">.</span><span class="nx">message</span>
                  <span class="nv">response.message = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;shortener_error&#39;</span><span class="p">,</span>
                    <span class="nx">response</span><span class="p">.</span><span class="nx">shortener</span>
                <span class="nv">ext.message = </span><span class="nx">response</span><span class="p">.</span><span class="nx">message</span>
                <span class="nv">ext.status  = </span><span class="kc">no</span>
                <span class="nx">showNotification</span><span class="p">()</span>
          <span class="k">else</span>
            <span class="nx">copyOutput</span> <span class="nx">output</span>
      <span class="k">else</span>
</pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Close the popup if it's still open.</p>             </td>             <td class="code">               <div class="highlight"><pre>
        <span class="nx">popup</span><span class="o">?</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Retrieve the first feature that passes the specified <code>filter</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">queryFeature = </span><span class="nf">(filter) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">filter</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="k">return</span> <span class="nx">feature</span> <span class="k">for</span> <span class="nx">feature</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">features</span> <span class="k">when</span> <span class="nx">filter</span> <span class="nx">feature</span>

</pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Remove the feature <code>name</code> from the persisted list.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">removeFeatureName = </span><span class="nf">(name) -&gt;</span>
  <span class="nv">features = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;features&#39;</span>
  <span class="nv">idx      = </span><span class="nx">features</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">name</span>
  <span class="k">if</span> <span class="nx">idx</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nx">features</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">idx</span><span class="p">,</span> <span class="mi">1</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="nx">features</span>

</pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Persist the settings for <code>feature</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">saveFeature = </span><span class="nf">(feature) -&gt;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_content&quot;</span><span class="p">,</span>  <span class="nx">feature</span><span class="p">.</span><span class="nx">content</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_enabled&quot;</span><span class="p">,</span>  <span class="nx">feature</span><span class="p">.</span><span class="nx">enabled</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_image&quot;</span><span class="p">,</span>    <span class="nx">feature</span><span class="p">.</span><span class="nx">image</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_index&quot;</span><span class="p">,</span>    <span class="nx">feature</span><span class="p">.</span><span class="nx">index</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_readonly&quot;</span><span class="p">,</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">readOnly</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_shortcut&quot;</span><span class="p">,</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">shortcut</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_title&quot;</span><span class="p">,</span>    <span class="nx">feature</span><span class="p">.</span><span class="nx">title</span>
  <span class="nx">feature</span>

</pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Display a desktop notification informing the user on whether or not the copy
request was successful. <br />
Also ensure that <code>ext</code> is <em>reset</em> and that notifications are only displayed
if the user has enabled the corresponding option (enabled by default).</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">showNotification = </span><span class="o">-&gt;</span>
  <span class="k">if</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;notifications&#39;</span>
    <span class="nx">webkitNotifications</span><span class="p">.</span><span class="nx">createHTMLNotification</span><span class="p">(</span>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">getURL</span> <span class="s1">&#39;pages/notification.html&#39;</span>
    <span class="p">).</span><span class="nx">show</span><span class="p">()</span>
  <span class="k">else</span>
    <span class="nx">ext</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
</pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Close the popup if it's still open.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">getViews</span><span class="p">(</span><span class="nv">type: </span><span class="s1">&#39;popup&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Update the context menu items to reflect the current enabled features. <br />
If the context menu option has been disabled by the user, just remove all of
the existing menu items.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">updateContextMenu = </span><span class="o">-&gt;</span>
</pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Ensure that any previously added context menu items are removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">chrome.contextMenus.removeAll = </span><span class="o">-&gt;</span>
</pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Called whenever a menu item is clicked. <br />
Send a self request, passing along the available information.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">onMenuClick = </span><span class="nf">(info, tab) -&gt;</span>
      <span class="nx">onRequest</span>
        <span class="nv">data: </span><span class="nx">info</span>
        <span class="nv">type: </span><span class="s1">&#39;menu&#39;</span>
    <span class="k">if</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;contextMenu&#39;</span>
</pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Create and add the top-level Template menu.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">parentId = </span><span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span>
        <span class="nv">contexts: </span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="nv">title: </span>   <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;name&#39;</span>
</pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Create and add a sub-menu item for each enabled feature.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">for</span> <span class="nx">feature</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">features</span> <span class="k">when</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">enabled</span>
        <span class="nv">menuId = </span><span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span>
          <span class="nv">contexts: </span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
          <span class="nv">onclick: </span> <span class="nx">onMenuClick</span>
          <span class="nv">parentId: </span><span class="nx">parentId</span>
          <span class="nv">title: </span>   <span class="nx">feature</span><span class="p">.</span><span class="nx">title</span>
        <span class="nv">feature.menuId = </span><span class="nx">menuId</span>

</pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <h2>Data functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Extract additional information from <code>tab</code> and add it to <code>data</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">addAdditionalData = </span><span class="nf">(tab, data, callback) -&gt;</span>
  <span class="nx">chrome</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">getAll</span> <span class="nv">url: </span><span class="nx">data</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nf">(cookies) -&gt;</span>
    <span class="nv">names     = </span><span class="p">[]</span>
    <span class="nx">cookies</span> <span class="o">or=</span> <span class="p">[]</span>
</pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Extract the names of each cookie.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span> <span class="k">for</span> <span class="nx">cookie</span> <span class="k">in</span> <span class="nx">cookies</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">data</span><span class="p">,</span>
      <span class="nv">cookie: </span><span class="o">-&gt;</span>
        <span class="nf">(text, render) -&gt;</span>
          <span class="nv">name  = </span><span class="nx">render</span> <span class="nx">text</span>
</pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Attempt to find the value for the cookie name.</p>             </td>             <td class="code">               <div class="highlight"><pre>
          <span class="k">return</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">value</span> <span class="k">for</span> <span class="nx">cookie</span> <span class="k">in</span> <span class="nx">cookies</span> <span class="k">when</span> <span class="nx">cookie</span><span class="p">.</span><span class="nx">name</span> <span class="o">is</span> <span class="nx">name</span>
          <span class="k">return</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">cookies: </span><span class="nx">names</span>
</pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Try to prevent pages hanging because content script wasn't executed.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">isProtectedPage</span> <span class="nx">tab</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nv">selection: </span>     <span class="s1">&#39;&#39;</span>
        <span class="nv">selectionlinks: </span><span class="p">[]</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">sendRequest</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{},</span> <span class="nf">(response) -&gt;</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">data</span><span class="p">,</span>
          <span class="nv">selection: </span>     <span class="nx">response</span><span class="p">.</span><span class="nx">text</span> <span class="o">or</span> <span class="s1">&#39;&#39;</span>
          <span class="nv">selectionlinks: </span><span class="nx">response</span><span class="p">.</span><span class="nx">urls</span> <span class="o">or</span> <span class="p">[]</span>
        <span class="nx">callback</span><span class="o">?</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Creates an object containing data based on information derived from the
specified tab and menu item data.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">buildDerivedData = </span><span class="nf">(tab, onClickData, shortCallback) -&gt;</span>
  <span class="nv">data =</span>
    <span class="nv">title: </span><span class="nx">tab</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">url: </span>  <span class="s1">&#39;&#39;</span>
  <span class="k">if</span> <span class="nx">onClickData</span><span class="p">.</span><span class="nx">linkUrl</span>
    <span class="nv">data.url = </span><span class="nx">onClickData</span><span class="p">.</span><span class="nx">linkUrl</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">onClickData</span><span class="p">.</span><span class="nx">srcUrl</span>
    <span class="nv">data.url = </span><span class="nx">onClickData</span><span class="p">.</span><span class="nx">srcUrl</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">onClickData</span><span class="p">.</span><span class="nx">frameUrl</span>
    <span class="nv">data.url = </span><span class="nx">onClickData</span><span class="p">.</span><span class="nx">frameUrl</span>
  <span class="k">else</span>
    <span class="nv">data.url = </span><span class="nx">onClickData</span><span class="p">.</span><span class="nx">pageUrl</span>
  <span class="nx">buildStandardData</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">shortCallback</span>

</pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Construct a data object based on information extracted from <code>tab</code>. <br />
The tab information is then merged with additional information relating to
the URL of the tab. <br />
If a shortened URL is requested when parsing the feature's content later,
<code>shortCallback</code> is called to handle this as we don't want to call a URL
shortener service unless it is actually required.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">buildStandardData = </span><span class="nf">(tab, shortCallback) -&gt;</span>
  <span class="nv">compatibility = </span><span class="kc">no</span>
  <span class="nv">data          = </span><span class="p">{}</span>
  <span class="nv">title         = </span><span class="s1">&#39;&#39;</span>
  <span class="nv">url           = </span><span class="p">{}</span>
</pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Check for any support extensions running on the current tab by simply
checking the tabs URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">for</span> <span class="nx">extension</span> <span class="k">in</span> <span class="nx">SUPPORT</span> <span class="k">when</span> <span class="nx">isExtensionActive</span> <span class="nx">tab</span><span class="p">,</span> <span class="nx">extension</span><span class="p">.</span><span class="nx">id</span>
    <span class="nv">title = </span><span class="nx">extension</span><span class="p">.</span><span class="nx">title</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">url   = </span><span class="nx">$</span><span class="p">.</span><span class="nx">url</span> <span class="nx">extension</span><span class="p">.</span><span class="nx">url</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">compatibility = </span><span class="kc">yes</span>
    <span class="k">break</span>
</pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Derive the initial data from the tab itself if no supported extensions were
found to be active.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">unless</span> <span class="nx">compatibility</span>
    <span class="nv">title = </span><span class="nx">tab</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">url   = </span><span class="nx">$</span><span class="p">.</span><span class="nx">url</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>
</pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Merge the initial data with the attributes of the <a href="https://github.com/allmarkedup/jQuery-URL-Parser">URL
parser</a> and all of the
custom Template properties. <br />
All properties should be in lower case so that they can be looked up
ignoring case by our modified version of
<a href="https://github.com/janl/mustache.js">mustache.js</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">url</span><span class="p">.</span><span class="nx">attr</span><span class="p">(),</span>
    <span class="nv">bitly: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitly&#39;</span>
    <span class="nv">bitlyapikey: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitlyApiKey&#39;</span>
    <span class="nv">bitlyusername: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;bitlyUsername&#39;</span>
    <span class="nv">browser: </span><span class="nx">browser</span><span class="p">.</span><span class="nx">title</span>
    <span class="nv">browserversion: </span><span class="nx">browser</span><span class="p">.</span><span class="nx">version</span>
    <span class="nv">contextmenu: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;contextMenu&#39;</span>
    <span class="nv">cookiesenabled: </span><span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">cookieEnabled</span>
    <span class="nv">datetime: </span><span class="o">-&gt;</span>
      <span class="nf">(text, render) -&gt;</span>
        <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">format</span> <span class="nx">render</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">or</span> <span class="kc">undefined</span>
    <span class="nv">decode: </span><span class="o">-&gt;</span>
      <span class="nf">(text, render) -&gt;</span>
        <span class="nb">decodeURIComponent</span> <span class="nx">render</span> <span class="nx">text</span>
    <span class="nv">doanchortarget: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;doAnchorTarget&#39;</span>
    <span class="nv">doanchortitle: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;doAnchorTitle&#39;</span>
    <span class="nv">encode: </span><span class="o">-&gt;</span>
      <span class="nf">(text, render) -&gt;</span>
        <span class="nb">encodeURIComponent</span> <span class="nx">render</span> <span class="nx">text</span>
</pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Deprecated since 0.1.0.2, use <code>encode</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">encoded: </span><span class="nb">encodeURIComponent</span> <span class="nx">url</span><span class="p">.</span><span class="nx">attr</span> <span class="s1">&#39;source&#39;</span>
    <span class="nv">favicon: </span><span class="nx">tab</span><span class="p">.</span><span class="nx">favIconUrl</span>
    <span class="nv">fparam: </span><span class="o">-&gt;</span>
      <span class="nf">(text, render) -&gt;</span>
        <span class="nx">url</span><span class="p">.</span><span class="nx">fparam</span> <span class="nx">render</span> <span class="nx">text</span>
    <span class="nv">fparams: </span><span class="nx">url</span><span class="p">.</span><span class="nx">fparam</span><span class="p">()</span>
    <span class="nv">fsegment: </span><span class="o">-&gt;</span>
      <span class="nf">(text, render) -&gt;</span>
        <span class="nx">url</span><span class="p">.</span><span class="nx">fsegment</span> <span class="nb">parseInt</span> <span class="nx">render</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span> <span class="mi">10</span>
    <span class="nv">fsegments: </span><span class="nx">url</span><span class="p">.</span><span class="nx">fsegment</span><span class="p">()</span>
    <span class="nv">googl: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;googl&#39;</span>
    <span class="nv">googloauth: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;googlOAuth&#39;</span>
    <span class="nv">java: </span><span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">javaEnabled</span><span class="p">()</span>
    <span class="nv">notificationduration: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;notificationDuration&#39;</span> <span class="o">*</span> <span class="p">.</span><span class="mi">001</span>
    <span class="nv">notifications: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;notifications&#39;</span>
    <span class="nv">offline: </span><span class="o">not</span> <span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">onLine</span>
</pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Deprecated since 0.1.0.2, use <code>originalUrl</code> instead.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">originalsource: </span><span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">originaltitle: </span><span class="nx">tab</span><span class="p">.</span><span class="nx">title</span> <span class="o">or</span> <span class="nx">url</span><span class="p">.</span><span class="nx">attr</span> <span class="s1">&#39;source&#39;</span>
    <span class="nv">originalurl: </span><span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>
    <span class="nv">os: </span><span class="nx">operatingSystem</span>
    <span class="nv">param: </span><span class="o">-&gt;</span>
      <span class="nf">(text, render) -&gt;</span>
        <span class="nx">url</span><span class="p">.</span><span class="nx">param</span> <span class="nx">render</span> <span class="nx">text</span>
    <span class="nv">params: </span><span class="nx">url</span><span class="p">.</span><span class="nx">param</span><span class="p">()</span>
    <span class="nv">segment: </span><span class="o">-&gt;</span>
      <span class="nf">(text, render) -&gt;</span>
        <span class="nx">url</span><span class="p">.</span><span class="nx">segment</span> <span class="nb">parseInt</span> <span class="nx">render</span><span class="p">(</span><span class="nx">text</span><span class="p">),</span> <span class="mi">10</span>
    <span class="nv">segments: </span><span class="nx">url</span><span class="p">.</span><span class="nx">segment</span><span class="p">()</span>
    <span class="nv">short: </span><span class="o">-&gt;</span>
      <span class="nx">shortCallback</span><span class="o">?</span><span class="p">()</span>
    <span class="nv">shortcuts: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortcuts&#39;</span>
    <span class="nv">title: </span><span class="nx">title</span> <span class="o">or</span> <span class="nx">url</span><span class="p">.</span><span class="nx">attr</span> <span class="s1">&#39;source&#39;</span>
    <span class="nv">toolbarfeature: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbarFeature&#39;</span>
    <span class="nv">toolbarfeaturedetails: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbarFeatureDetails&#39;</span>
    <span class="nv">toolbarfeaturename: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbarFeatureName&#39;</span>
    <span class="nv">toolbarpopup: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbarPopup&#39;</span>
    <span class="nv">url: </span><span class="nx">url</span><span class="p">.</span><span class="nx">attr</span> <span class="s1">&#39;source&#39;</span>
    <span class="nv">version: </span><span class="nx">ext</span><span class="p">.</span><span class="nx">version</span>
    <span class="nv">yourls: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourls&#39;</span>
    <span class="nv">yourlspassword: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsPassword&#39;</span>
    <span class="nv">yourlssignature: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsSignature&#39;</span>
    <span class="nv">yourlsurl: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsUrl&#39;</span>
    <span class="nv">yourlsusername: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;yourlsUsername&#39;</span>
  <span class="nx">data</span>

</pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <h2>HTML building functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Create an <code>li</code> element to represent <code>feature</code>. <br />
The element should then be inserted in to the <code>ul</code> element in the popup page
but is created here to optimize display times for the popup.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">buildFeature = </span><span class="nf">(feature) -&gt;</span>
  <span class="nv">image   = </span><span class="nx">getImagePathForFeature</span> <span class="nx">feature</span><span class="p">,</span> <span class="kc">yes</span>
  <span class="nx">image</span> <span class="o">or=</span> <span class="s1">&#39;../images/spacer.png&#39;</span>
  <span class="nv">item    = </span><span class="nx">$</span> <span class="s1">&#39;&lt;li/&gt;&#39;</span><span class="p">,</span>
    <span class="nv">name: </span>   <span class="nx">feature</span><span class="p">.</span><span class="nx">name</span>
    <span class="nv">onclick: </span><span class="s1">&#39;popup.sendRequest(this)&#39;</span>
  <span class="nv">menu    = </span><span class="nx">$</span> <span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">,</span>
    <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;menu&#39;</span>
    <span class="nv">style: </span><span class="s2">&quot;background-image: url(&#39;#{image}&#39;)&quot;</span>
  <span class="nx">menu</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span> <span class="s1">&#39;&lt;span/&gt;&#39;</span><span class="p">,</span>
    <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span>
    <span class="nv">text: </span> <span class="nx">feature</span><span class="p">.</span><span class="nx">title</span>
  <span class="k">if</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;shortcuts&#39;</span>
    <span class="nv">modifiers = </span><span class="nx">ext</span><span class="p">.</span><span class="nx">SHORTCUT_MODIFIERS</span>
    <span class="nv">modifiers = </span><span class="nx">ext</span><span class="p">.</span><span class="nx">SHORTCUT_MAC_MODIFIERS</span> <span class="k">if</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">isThisPlatform</span> <span class="s1">&#39;mac&#39;</span>
    <span class="nx">menu</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span> <span class="s1">&#39;&lt;span/&gt;&#39;</span><span class="p">,</span>
      <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;shortcut&#39;</span><span class="p">,</span>
      <span class="nv">html: </span> <span class="k">if</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">shortcut</span> <span class="k">then</span> <span class="nx">modifiers</span> <span class="o">+</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">shortcut</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">item</span><span class="p">.</span><span class="nx">append</span> <span class="nx">menu</span>

</pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Build the HTML to populate the popup with to optimize popup loading times.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">buildPopup = </span><span class="o">-&gt;</span>
  <span class="nv">item     = </span><span class="nx">$</span> <span class="s1">&#39;&lt;div id=&quot;item&quot;/&gt;&#39;</span>
  <span class="nv">itemList = </span><span class="nx">$</span> <span class="s1">&#39;&lt;ul id=&quot;itemList&quot;/&gt;&#39;</span>
  <span class="nv">loadDiv  = </span><span class="nx">$</span> <span class="s1">&#39;&lt;div id=&quot;loadDiv&quot;/&gt;&#39;</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">append</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">loadDiv</span> <span class="p">[</span>
    <span class="nx">$</span> <span class="s1">&#39;&lt;img src=&quot;../images/loading.gif&quot;/&gt;&#39;</span>
    <span class="nx">$</span> <span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">,</span> <span class="nv">text: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;shortening&#39;</span>
  <span class="p">]</span>
</pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Generate the HTML for each feature.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">for</span> <span class="nx">feature</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">features</span> <span class="k">when</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">enabled</span>
    <span class="nx">itemList</span><span class="p">.</span><span class="nx">append</span> <span class="nx">buildFeature</span> <span class="nx">feature</span>
</pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Add a generic message to state the obvious... that the list is empty.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">itemList</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="nx">itemList</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;li/&gt;&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">,</span>
      <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;menu&#39;</span>
      <span class="nv">style: </span><span class="s2">&quot;background-image: url(&#39;../images/spacer.png&#39;)&quot;</span>
    <span class="p">).</span><span class="nx">append</span> <span class="nx">$</span> <span class="s1">&#39;&lt;span/&gt;&#39;</span><span class="p">,</span>
      <span class="k">class</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span>
      <span class="nv">style: </span><span class="s1">&#39;margin-left: 0&#39;</span>
      <span class="nv">text: </span> <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;empty&#39;</span>
  <span class="nx">item</span><span class="p">.</span><span class="nx">append</span> <span class="nx">itemList</span>
  <span class="nv">ext.popupHtml = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;div/&gt;&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">loadDiv</span><span class="p">,</span> <span class="nx">item</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <h2>Initialization functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Handle the conversion/removal of older version of settings that may have
been stored previously by <code>ext.init</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">init_update = </span><span class="o">-&gt;</span>
  <span class="nv">update_progress = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;update_progress&#39;</span>
  <span class="nx">update_progress</span><span class="p">.</span><span class="nx">settings</span> <span class="o">?=</span> <span class="p">[]</span>
</pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Check if the settings need updated for 0.1.0.0.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">update_progress</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;0.1.0.0&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Update the settings for 0.1.0.0.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingNotification&#39;</span><span class="p">,</span> <span class="s1">&#39;notifications&#39;</span><span class="p">,</span> <span class="kc">on</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingNotificationTimer&#39;</span><span class="p">,</span> <span class="s1">&#39;notificationDuration&#39;</span><span class="p">,</span> <span class="mi">3000</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingShortcut&#39;</span><span class="p">,</span> <span class="s1">&#39;shortcuts&#39;</span><span class="p">,</span> <span class="kc">on</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingTargetAttr&#39;</span><span class="p">,</span> <span class="s1">&#39;doAnchorTarget&#39;</span><span class="p">,</span> <span class="kc">off</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;settingTitleAttr&#39;</span><span class="p">,</span> <span class="s1">&#39;doAnchorTitle&#39;</span><span class="p">,</span> <span class="kc">off</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;settingIeTabExtract&#39;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;settingIeTabTitle&#39;</span>
</pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Ensure that settings are not updated for 0.1.0.0 again.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">update_progress</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">push</span> <span class="s1">&#39;0.1.0.0&#39;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;update_progress&#39;</span><span class="p">,</span> <span class="nx">update_progress</span>

</pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Initilaize the settings for <code>feature</code>. <br />
Store the name of the <code>feature</code> in the persisted list of managed features.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initFeature = </span><span class="nf">(feature) -&gt;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_content&quot;</span><span class="p">,</span>   <span class="nx">feature</span><span class="p">.</span><span class="nx">content</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s2">&quot;feat_#{feature.name}_enabled&quot;</span><span class="p">,</span>  <span class="nx">feature</span><span class="p">.</span><span class="nx">enabled</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s2">&quot;feat_#{feature.name}_image&quot;</span><span class="p">,</span>    <span class="nx">feature</span><span class="p">.</span><span class="nx">image</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s2">&quot;feat_#{feature.name}_index&quot;</span><span class="p">,</span>    <span class="nx">feature</span><span class="p">.</span><span class="nx">index</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_readonly&quot;</span><span class="p">,</span>  <span class="nx">feature</span><span class="p">.</span><span class="nx">readOnly</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s2">&quot;feat_#{feature.name}_shortcut&quot;</span><span class="p">,</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">shortcut</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{feature.name}_title&quot;</span><span class="p">,</span>     <span class="nx">feature</span><span class="p">.</span><span class="nx">title</span>
  <span class="nx">addFeatureName</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">name</span>
  <span class="nx">feature</span>

</pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Initialize the persisted managed features.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initFeatures = </span><span class="o">-&gt;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="p">[]</span>
  <span class="nx">initFeatures_update</span><span class="p">()</span>
  <span class="nx">initFeature</span> <span class="nx">feature</span> <span class="k">for</span> <span class="nx">feature</span> <span class="k">in</span> <span class="nx">DEFAULT_FEATURES</span>
  <span class="nx">ext</span><span class="p">.</span><span class="nx">updateFeatures</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Handle the conversion/removal of older version of settings that may have
been stored previously by <code>initFeatures</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initFeatures_update = </span><span class="o">-&gt;</span>
  <span class="nv">update_progress = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;update_progress&#39;</span>
  <span class="nx">update_progress</span><span class="p">.</span><span class="nx">features</span> <span class="o">?=</span> <span class="p">[]</span>
</pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Check if the features need updated for 0.1.0.0.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">update_progress</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;0.1.0.0&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Update the features for 0.1.0.0.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyAnchorEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__anchor_enabled&#39;</span><span class="p">,</span> <span class="kc">yes</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyAnchorOrder&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__anchor_index&#39;</span><span class="p">,</span> <span class="mi">2</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyBBCodeEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__bbcode_enabled&#39;</span><span class="p">,</span> <span class="kc">no</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyBBCodeOrder&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__bbcode_index&#39;</span><span class="p">,</span> <span class="mi">4</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyEncodedEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__encoded_enabled&#39;</span><span class="p">,</span> <span class="kc">yes</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyEncodedOrder&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__encoded_index&#39;</span><span class="p">,</span> <span class="mi">3</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyShortEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__short_enabled&#39;</span><span class="p">,</span> <span class="kc">yes</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyShortOrder&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__short_index&#39;</span><span class="p">,</span> <span class="mi">1</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyUrlEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__url_enabled&#39;</span><span class="p">,</span> <span class="kc">yes</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;copyUrlOrder&#39;</span><span class="p">,</span> <span class="s1">&#39;feat__url_index&#39;</span><span class="p">,</span> <span class="mi">0</span>
</pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Ensure that features are not updated for 0.1.0.0 again.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">update_progress</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">push</span> <span class="s1">&#39;0.1.0.0&#39;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;update_progress&#39;</span><span class="p">,</span> <span class="nx">update_progress</span>
</pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Check if the features need updated for 0.2.0.0.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">update_progress</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;0.2.0.0&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Update the features for 0.2.0.0.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">names = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;features&#39;</span>
    <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;features&#39;</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s2">&quot;feat_#{name}_template&quot;</span><span class="p">,</span> <span class="s2">&quot;feat_#{name}_content&quot;</span>
      <span class="nv">image = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;feat_#{name}_image&quot;</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">image</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
        <span class="k">for</span> <span class="nx">img</span> <span class="k">in</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">IMAGES</span> <span class="k">when</span> <span class="nx">img</span><span class="p">.</span><span class="nx">file</span> <span class="o">is</span> <span class="nx">image</span>
          <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{name}_image&quot;</span><span class="p">,</span> <span class="nx">img</span><span class="p">.</span><span class="nx">id</span>
          <span class="k">break</span>
      <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">image</span> <span class="o">is</span> <span class="s1">&#39;undefined&#39;</span>
        <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;feat_#{name}_image&quot;</span><span class="p">,</span> <span class="mi">0</span>
</pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Ensure that features are not updated for 0.2.0.0 again.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">update_progress</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">push</span> <span class="s1">&#39;0.2.0.0&#39;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;update_progress&#39;</span><span class="p">,</span> <span class="nx">update_progress</span>

</pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Initialize the settings related to the toolbar/browser action.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initToolbar = </span><span class="o">-&gt;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;toolbarPopup&#39;</span><span class="p">,</span> <span class="kc">on</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;toolbarFeature&#39;</span><span class="p">,</span> <span class="kc">off</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;toolbarFeatureDetails&#39;</span><span class="p">,</span> <span class="kc">off</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;toolbarFeatureName&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">ext</span><span class="p">.</span><span class="nx">updateToolbar</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Initialize the settings related to the supported URL Shortener services.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initUrlShorteners = </span><span class="o">-&gt;</span>
  <span class="nx">initUrlShorteners_update</span><span class="p">()</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;bitly&#39;</span><span class="p">,</span> <span class="kc">off</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;bitlyApiKey&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;bitlyUsername&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;googl&#39;</span><span class="p">,</span> <span class="kc">on</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;googlOAuth&#39;</span><span class="p">,</span> <span class="kc">on</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;yourls&#39;</span><span class="p">,</span> <span class="kc">off</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;yourlsPassword&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;yourlsSignature&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;yourlsUrl&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;yourlsUsername&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Handle the conversion/removal of older version of settings that may have
been stored previously by <code>initUrlShorteners</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">initUrlShorteners_update = </span><span class="o">-&gt;</span>
  <span class="nv">update_progress = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;update_progress&#39;</span>
  <span class="nx">update_progress</span><span class="p">.</span><span class="nx">shorteners</span> <span class="o">?=</span> <span class="p">[]</span>
</pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>Check if the URL shorteners need updated for 0.1.0.0.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">if</span> <span class="nx">update_progress</span><span class="p">.</span><span class="nx">shorteners</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;0.1.0.0&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
</pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Update the URL shorteners for 0.1.0.0.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;bitlyEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;bitly&#39;</span><span class="p">,</span> <span class="kc">off</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;bitlyXApiKey&#39;</span><span class="p">,</span> <span class="s1">&#39;bitlyApiKey&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;bitlyXLogin&#39;</span><span class="p">,</span> <span class="s1">&#39;bitlyUsername&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;googleEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;googl&#39;</span><span class="p">,</span> <span class="kc">on</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">rename</span> <span class="s1">&#39;googleOAuthEnabled&#39;</span><span class="p">,</span> <span class="s1">&#39;googlOAuth&#39;</span><span class="p">,</span> <span class="kc">on</span>
</pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Ensure that URL shorteners are not updated for 0.1.0.0 again.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">update_progress</span><span class="p">.</span><span class="nx">shorteners</span><span class="p">.</span><span class="nx">push</span> <span class="s1">&#39;0.1.0.0&#39;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;update_progress&#39;</span><span class="p">,</span> <span class="nx">update_progress</span>

</pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <h2>URL shortener functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Call the active URL shortener service for <code>url</code> in order to obtain the
relevant short URL. <br />
<code>callback</code> will be called with the result once it has been received from the
URL shortener service.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">callUrlShortener = </span><span class="nf">(url, callback) -&gt;</span>
  <span class="nx">callUrlShortenerHelper</span> <span class="nx">url</span><span class="p">,</span> <span class="nf">(url, service) -&gt;</span>
    <span class="nv">name = </span><span class="nx">service</span><span class="p">.</span><span class="nx">name</span>
    <span class="nv">sUrl = </span><span class="nx">service</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span>
    <span class="nx">unless</span> <span class="nx">sUrl</span>
</pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Should never happen... Really just a sanity check.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span>
        <span class="nv">message: </span>  <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;shortener_config_error&#39;</span><span class="p">,</span> <span class="nx">name</span>
        <span class="nv">shortener: </span><span class="nx">name</span>
        <span class="nv">success: </span>  <span class="kc">no</span>
      <span class="p">)</span>
      <span class="k">return</span>
    <span class="k">try</span>
      <span class="nv">params = </span><span class="nx">service</span><span class="p">.</span><span class="nx">getParameters</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">or</span> <span class="p">{}</span>
</pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Build the HTTP request for the URL shortener service.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">req = </span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">()</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">open</span> <span class="nx">service</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="s2">&quot;#{sUrl}?#{$.param params}&quot;</span><span class="p">,</span> <span class="kc">yes</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">contentType</span>
</pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Setup the OAuth header, if required.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">service</span><span class="p">.</span><span class="nx">oauth</span> <span class="o">and</span> <span class="nx">service</span><span class="p">.</span><span class="nx">isOAuthEnabled</span><span class="p">()</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span> <span class="s1">&#39;Authorization&#39;</span><span class="p">,</span>
          <span class="nx">service</span><span class="p">.</span><span class="nx">oauth</span><span class="p">.</span><span class="nx">getAuthorizationHeader</span> <span class="nx">sUrl</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">params</span>
</pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Wait for the response and let the service handle it before passing the
result to <code>callback</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">req.onreadystatechange = </span><span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">is</span> <span class="mi">4</span>
          <span class="nx">callback</span><span class="o">?</span><span class="p">(</span>
            <span class="nv">shortUrl: </span> <span class="nx">service</span><span class="p">.</span><span class="nx">output</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span>
            <span class="nv">shortener: </span><span class="nx">name</span>
            <span class="nv">success: </span>  <span class="kc">yes</span>
          <span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>Finally, send the HTTP request.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">req</span><span class="p">.</span><span class="nx">send</span> <span class="nx">service</span><span class="p">.</span><span class="nx">input</span> <span class="nx">url</span>
    <span class="k">catch</span> <span class="nx">error</span>
</pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>Aw snap! Notify the user via <code>callback</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="o">or</span> <span class="nx">error</span>
      <span class="nx">callback</span><span class="o">?</span><span class="p">(</span>
        <span class="nv">message: </span>  <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;shortener_error&#39;</span><span class="p">,</span> <span class="nx">name</span>
        <span class="nv">shortener: </span><span class="nx">name</span>
        <span class="nv">success: </span>  <span class="kc">no</span>
      <span class="p">)</span>

</pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Determine when <code>callback</code> is called depending on whether or not the active
URL Shortener supports <a href="http://oauth.net">OAuth</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">callUrlShortenerHelper = </span><span class="nf">(url, callback) -&gt;</span>
  <span class="nv">service = </span><span class="nx">getUrlShortener</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">service</span><span class="p">.</span><span class="nx">oauth</span> <span class="o">and</span> <span class="nx">service</span><span class="p">.</span><span class="nx">isOAuthEnabled</span><span class="p">()</span>
    <span class="nx">service</span><span class="p">.</span><span class="nx">oauth</span><span class="p">.</span><span class="nx">authorize</span> <span class="o">-&gt;</span>
      <span class="nx">callback</span><span class="o">?</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">service</span>
  <span class="k">else</span>
    <span class="nx">callback</span><span class="o">?</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">service</span>

</pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>Retrieve the active URL shortener service.</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">getUrlShortener = </span><span class="o">-&gt;</span>
</pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>Attempt to lookup enabled URL shortener service.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="k">return</span> <span class="nx">shortener</span> <span class="k">for</span> <span class="nx">shortener</span> <span class="k">in</span> <span class="nx">SHORTENERS</span> <span class="k">when</span> <span class="nx">shortener</span><span class="p">.</span><span class="nx">isEnabled</span><span class="p">()</span>
</pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>Should never reach here but we'll return goo.gl service by default after
ensuring it's the active URL shortener service from now on to save some
time.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;googl&#39;</span><span class="p">,</span> <span class="kc">yes</span>
  <span class="nx">SHORTENERS</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

</pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <h2>Background page setup</h2>             </td>             <td class="code">               <div class="highlight"><pre>

<span class="nv">ext = </span><span class="nb">window</span><span class="p">.</span><span class="nv">ext =</span>

</pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <h2>Public constants</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>List of images available as feature icons.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">IMAGES: </span><span class="p">[</span>
    <span class="nv">file: </span>    <span class="s1">&#39;spacer.gif&#39;</span>
    <span class="nv">id: </span>      <span class="mi">0</span>
    <span class="nv">name: </span>    <span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_none&#39;</span>
    <span class="nv">separate: </span><span class="kc">yes</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_auction.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">1</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_auction&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_bug.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">2</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_bug&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_clipboard.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">3</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_clipboard&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_clipboard_empty.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">4</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_clipboard_empty&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_component.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">5</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_component&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_cookies.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">6</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_cookies&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_discussion.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">7</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_discussion&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_globe.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">8</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_globe&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_google.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">9</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_google&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_heart.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">10</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_heart&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_html.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">11</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_html&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_key.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">12</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_key&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_lightbulb.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">13</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_lightbulb&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_lighthouse.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">14</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_lighthouse&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_lightning.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">15</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_lightning&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_link.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">16</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_link&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_linux.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">17</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_linux&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_mail.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">18</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_mail&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_newspaper.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">19</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_newspaper&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_note.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">20</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_note&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_page.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">21</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_page&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_plugin.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">22</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_plugin&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_rss.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">23</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_rss&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_script.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">24</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_script&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_scull.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">25</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_scull&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_sign.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">26</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_sign&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_siren.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">27</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_siren&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_star.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">28</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_star&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_support.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">29</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_support&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_tag.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">30</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_tag&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_tags.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">31</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_tags&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_thumb_down.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">32</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_thumb_down&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_thumb_up.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">33</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_thumb_up&#39;</span>
  <span class="p">,</span>
    <span class="nv">file: </span><span class="s1">&#39;feat_tools.png&#39;</span>
    <span class="nv">id: </span>  <span class="mi">34</span>
    <span class="nv">name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;feat_tools&#39;</span>
  <span class="p">]</span>

</pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>String representation of the keyboard modifiers listened to by Template on
Windows/Linux platforms.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">SHORTCUT_MODIFIERS: </span><span class="s1">&#39;Ctrl+Alt+&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>String representation of the keyboard modifiers listened to by Template on
Mac platforms.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">SHORTCUT_MAC_MODIFIERS: </span><span class="s1">&#39;&amp;#8679;&amp;#8997;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <h2>Public variables</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>List of copy request features being used by Template, ordered to match that
specified by the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">features: </span><span class="p">[]</span>

</pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Override message displayed in notifications. <br />
This should be reset to an empty string after every copy request.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">message: </span><span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>Pre-prepared HTML for the popup to be populated using. <br />
This should be updated whenever feature are changed/updated in any way as
this is generated to improve performance and load times of the popup frame.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">popupHtml: </span><span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Indicate whether or not the current copy request was a success. <br />
This should be reset to <code>false</code> after every copy request.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">status: </span><span class="kc">no</span>

</pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Current version of Template.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">version: </span><span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <h2>Public functions</h2>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>Add <code>str</code> to the system clipboard. <br />
All successful copy requests should, at some point, call this function. <br />
If <code>str</code> is empty the contents of the system clipboard will not change.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">copy: </span><span class="nf">(str, hidden) -&gt;</span>
    <span class="nv">result  = </span><span class="kc">no</span>
    <span class="nv">sandbox = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#sandbox&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">select</span><span class="p">()</span>
    <span class="nv">result  = </span><span class="nb">document</span><span class="p">.</span><span class="nx">execCommand</span> <span class="s1">&#39;copy&#39;</span>
    <span class="nx">sandbox</span><span class="p">.</span><span class="nx">val</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">unless</span> <span class="nx">hidden</span>
      <span class="nv">ext.status = </span><span class="nx">result</span>
      <span class="nx">showNotification</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>Initialize the background page. <br />
This will involve initializing the settings and adding the request
listeners.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">init: </span><span class="o">-&gt;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;update_progress&#39;</span><span class="p">,</span> <span class="p">{}</span>
    <span class="nx">init_update</span><span class="p">()</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;contextMenu&#39;</span><span class="p">,</span> <span class="kc">on</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;notifications&#39;</span><span class="p">,</span> <span class="kc">on</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;notificationDuration&#39;</span><span class="p">,</span> <span class="mi">3000</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;shortcuts&#39;</span><span class="p">,</span> <span class="kc">on</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;doAnchorTarget&#39;</span><span class="p">,</span> <span class="kc">off</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">init</span> <span class="s1">&#39;doAnchorTitle&#39;</span><span class="p">,</span> <span class="kc">off</span>
    <span class="nx">initFeatures</span><span class="p">()</span>
    <span class="nx">initToolbar</span><span class="p">()</span>
    <span class="nx">initUrlShorteners</span><span class="p">()</span>
</pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Add listener for toolbar/browser action clicks. <br />
This listener will be ignored whenever the popup is enabled.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">onClicked</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(tab) -&gt;</span>
      <span class="nx">onRequest</span>
        <span class="nv">data: name: </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbarFeatureName&#39;</span>
        <span class="nv">type: </span><span class="s1">&#39;popup&#39;</span>
</pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Add listeners for internal and external requests.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">onRequest</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">onRequest</span>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">onRequestExternal</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(req, sender, cb) -&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span><span class="o">?</span><span class="p">()</span> <span class="k">if</span> <span class="nx">isBlacklisted</span> <span class="nx">sender</span>
      <span class="nx">onRequest</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">sender</span><span class="p">,</span> <span class="nx">cb</span>
</pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>Derive the browser and OS information.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">browser.version = </span><span class="nx">getBrowserVersion</span><span class="p">()</span>
    <span class="nv">operatingSystem = </span><span class="nx">getOperatingSystem</span><span class="p">()</span>
</pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>It's nice knowing what version is running.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">getURL</span><span class="p">(</span><span class="s1">&#39;manifest.json&#39;</span><span class="p">),</span> <span class="nf">(data) -&gt;</span>
      <span class="nv">ext.version = </span><span class="nx">data</span><span class="p">.</span><span class="nx">version</span>
</pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>Execute content scripts now that we know the version.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">executeScriptsInExistingWindows</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>Determine whether or not <code>os</code> matches the user's operating system.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">isThisPlatform: </span><span class="nf">(os) -&gt;</span>
    <span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">os</span><span class="p">)</span> <span class="o">isnt</span> <span class="o">-</span><span class="mi">1</span>

</pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>Attempt to retrieve the contents of the system clipboard as a string.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">paste: </span><span class="o">-&gt;</span>
    <span class="nv">result  = </span><span class="s1">&#39;&#39;</span>
    <span class="nv">sandbox = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#sandbox&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">()</span>
    <span class="nv">result  = </span><span class="nx">sandbox</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span> <span class="k">if</span> <span class="nb">document</span><span class="p">.</span><span class="nx">execCommand</span> <span class="s1">&#39;paste&#39;</span>
    <span class="nx">sandbox</span><span class="p">.</span><span class="nx">val</span> <span class="s1">&#39;&#39;</span>
    <span class="nx">result</span>

</pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>Reset the message and status associated with the current copy request. <br />
This should be called when a copy request is completed regardless of its
outcome.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">reset: </span><span class="o">-&gt;</span>
    <span class="nv">ext.message = </span><span class="s1">&#39;&#39;</span>
    <span class="nv">ext.status  = </span><span class="kc">no</span>

</pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Persist the setting for each feature in <code>features</code>. <br />
Remove the settings for any features that are no longer in use in an
attempt to keep capacity under control.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">saveFeatures: </span><span class="nf">(features) -&gt;</span>
    <span class="nv">names    = </span><span class="p">[]</span>
    <span class="nv">oldNames = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;features&#39;</span>
    <span class="k">for</span> <span class="nx">feature</span> <span class="k">in</span> <span class="nx">features</span>
      <span class="nx">names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">name</span>
      <span class="nx">saveFeature</span> <span class="nx">feature</span>
</pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <p>Ensure that any obsolete features are removed from <code>localStorage</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">deleteFeature</span> <span class="nx">name</span> <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">oldNames</span> <span class="k">when</span> <span class="nx">names</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;features&#39;</span><span class="p">,</span> <span class="nx">names</span>
    <span class="nx">features</span>

</pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>Update the local list of features to reflect that persisted. <br />
It is very important that this is called whenever features may have changed
in order to prepare the popup HTML and optimize performance.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">updateFeatures: </span><span class="o">-&gt;</span>
    <span class="nv">ext.features = </span><span class="nx">loadFeatures</span><span class="p">()</span>
    <span class="nx">buildPopup</span><span class="p">()</span>
    <span class="nx">updateContextMenu</span><span class="p">()</span>

</pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Update the toolbar/browser action depending on the current settings.</p>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nv">updateToolbar: </span><span class="o">-&gt;</span>
    <span class="nv">featureName = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbarFeatureName&#39;</span>
    <span class="nv">image       = </span><span class="s1">&#39;images/icon_19.png&#39;</span>
    <span class="nv">title       = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">i18n</span> <span class="s1">&#39;name&#39;</span>
    <span class="nv">feature = </span><span class="nx">getFeatureWithName</span> <span class="nx">featureName</span> <span class="k">if</span> <span class="nx">featureName</span>
    <span class="k">if</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;toolbarPopup&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">feature</span>
</pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Use Template's details to style the browser action.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setIcon</span>  <span class="nv">path: </span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">getURL</span> <span class="nx">image</span>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setTitle</span> <span class="nv">title: </span><span class="nx">title</span>
</pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>Show the popup when the browser action is clicked.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setPopup</span> <span class="nv">popup: </span><span class="s1">&#39;pages/popup.html&#39;</span>
    <span class="k">else</span>
</pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>Replace Template's details with that of the selected feature.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;toolbarFeatureDetails&#39;</span>
        <span class="nv">image = </span><span class="nx">getImagePathForFeature</span> <span class="nx">feature</span> <span class="k">if</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">image</span> <span class="o">isnt</span> <span class="mi">0</span>
        <span class="nv">title = </span><span class="nx">feature</span><span class="p">.</span><span class="nx">title</span>
</pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>Potentially change the style of the browser action.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setIcon</span>  <span class="nv">path: </span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">getURL</span> <span class="nx">image</span>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setTitle</span> <span class="nv">title: </span><span class="nx">title</span>
</pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>Disable the popup, effectively enabling the listener for
<code>chrome.browserAction.onClicked</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">browserAction</span><span class="p">.</span><span class="nx">setPopup</span> <span class="nv">popup: </span><span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 