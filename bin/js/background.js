/* (c) 2011 Alasdair Mercer */
var clipboard={blacklistedExtensions:[],feature:'',features:[],status:false,copy:function(str){var sandbox=$('#sandbox').val(str).select();clipboard.status=document.execCommand('copy',false,null);sandbox.val('');clipboard.showNotification();},copyAnchor:function(tab){var data={href:tab.url};data.text=tab.title||data.href;if(tab.title&&utils.get('settingTitleAttr')){data.title=helper.addSlashes(data.text);}
data.text=helper.replaceEntities(data.text);clipboard.copy(helper.createAnchor(data));},copyBBCode:function(tab){var data={text:tab.title,url:tab.url};clipboard.copy(helper.createBBCode(data));},copyEncoded:function(tab){clipboard.copy(helper.encode(tab.url));},copyShortUrl:function(tab){helper.callUrlShortener(tab.url);},copyUrl:function(tab){clipboard.copy(tab.url);},executeScriptsInExistingTabs:function(tabs){for(var i=0;i<tabs.length;i++){chrome.tabs.executeScript(tabs[i].id,{'file':chrome.extension.getURL("js/shortcuts.js")});}},executeScriptsInExistingWindows:function(){chrome.windows.getAll(null,function(windows){for(var i=0;i<windows.length;i++){chrome.tabs.getAllInWindow(windows[i].id,clipboard.executeScriptsInExistingTabs);}});},getFeature:function(order){switch(order){case utils.get('copyAnchorOrder'):return feature.anchor;case utils.get('copyBBCodeOrder'):return feature.bbcode;case utils.get('copyEncodedOrder'):return feature.encoded;case utils.get('copyShortOrder'):return feature.short;case utils.get('copyUrlOrder'):return feature.url;default:return{};}},getUrlShortener:function(){for(var p in shortener){if(shortener.hasOwnProperty(p)){var op=shortener[p];if(op.isEnabled()){return op;}}}
return shortener.google;},init:function(){utils.init('settingNotification',true);utils.init('settingNotificationTimer',3000);utils.init('settingShortcut',true);utils.init('settingTargetAttr',false);utils.init('settingTitleAttr',false);utils.init('settingIeTabExtract',true);utils.init('settingIeTabTitle',true);clipboard.initFeatures();clipboard.initUrlShorteners();clipboard.executeScriptsInExistingWindows();chrome.extension.onRequest.addListener(clipboard.onRequest);chrome.extension.onRequestExternal.addListener(clipboard.onExternalRequest);},initFeatures:function(){utils.init('copyAnchorEnabled',true);utils.init('copyAnchorOrder',2);utils.init('copyBBCodeEnabled',false);utils.init('copyBBCodeOrder',4);utils.init('copyEncodedEnabled',true);utils.init('copyEncodedOrder',3);utils.init('copyShortEnabled',true);utils.init('copyShortOrder',1);utils.init('copyUrlEnabled',true);utils.init('copyUrlOrder',0);for(var p in feature){if(feature.hasOwnProperty(p)){var op=feature[p];op.html=helper.createFeatureHtml(op);}}
clipboard.updateFeatures();},initUrlShorteners:function(){utils.init('bitlyEnabled',false);utils.init('bitlyXApiKey','');utils.init('bitlyXLogin','');utils.init('googleEnabled',true);},isBlacklisted:function(sender){var reject=false;for(var i=0;i<clipboard.blacklistedExtensions.length;i++){if(clipboard.blacklistedExtensions[i]===sender.id){reject=true;break;}}
return reject;},isSpecialPage:function(tab){return tab.url.indexOf('chrome')===0;},isThisPlatform:function(operatingSystem){return navigator.userAgent.toLowerCase().indexOf(operatingSystem)!==-1;},onExternalRequest:function(request,sender,sendResponse){if(!clipboard.isBlacklisted(sender)){clipboard.onRequestHelper(request,sender,sendResponse);}},onRequest:function(request,sender,sendResponse){if(!request.shortcut||utils.get('settingShortcut')){clipboard.onRequestHelper(request,sender,sendResponse);}},onRequestHelper:function(request,sender,sendResponse){chrome.tabs.getSelected(null,function(tab){var handler=(ietab.isActive(tab))?ietab:clipboard;var popup=chrome.extension.getViews({type:'popup'})[0];switch(request.feature){case feature.url.name:clipboard.feature=feature.url.name;handler.copyUrl(tab);popup.close();break;case feature.short.name:$('#loadDiv',popup.document).show();$('#item',popup.document).hide();clipboard.feature=feature.short.name;handler.copyShortUrl(tab);break;case feature.anchor.name:clipboard.feature=feature.anchor.name;handler.copyAnchor(tab);popup.close();break;case feature.bbcode.name:clipboard.feature=feature.bbcode.name;handler.copyBBCode(tab);popup.close();break;case feature.encoded.name:clipboard.feature=feature.encoded.name;handler.copyEncoded(tab);popup.close();break;}});},reset:function(){clipboard.feature='';clipboard.status=false;},showNotification:function(){if(utils.get('settingNotification')){webkitNotifications.createHTMLNotification(chrome.extension.getURL("pages/notification.html")).show();}else{clipboard.reset();}},updateFeatures:function(){var count=helper.countProperties(feature);clipboard.features=[];for(var i=0;i<count;i++){clipboard.features[i]=clipboard.getFeature(i);}}};var feature={anchor:{getMacShortcut:function(){return'\u2325\u2318A';},getShortcut:function(){return'Ctrl+Alt+A';},html:'',id:'copyAnchor',isEnabled:function(){return utils.get('copyAnchorEnabled');},name:'copy_anchor'},bbcode:{getMacShortcut:function(){return'\u2325\u2318B';},getShortcut:function(){return'Ctrl+Alt+B';},html:'',id:'copyBBCode',isEnabled:function(){return utils.get('copyBBCodeEnabled');},name:'copy_bbcode'},encoded:{getMacShortcut:function(){return'\u2325\u2318E';},getShortcut:function(){return'Ctrl+Alt+E';},html:'',id:'copyEncodedUrl',isEnabled:function(){return utils.get('copyEncodedEnabled');},name:'copy_encoded'},short:{getMacShortcut:function(){return'\u2325\u2318S';},getShortcut:function(){return'Ctrl+Alt+S';},html:'',id:'copyShortUrl',isEnabled:function(){return utils.get('copyShortEnabled');},name:'copy_short'},url:{getMacShortcut:function(){return'\u2325\u2318U';},getShortcut:function(){return'Ctrl+Alt+U';},html:'',id:'copyUrl',isEnabled:function(){return utils.get('copyUrlEnabled');},name:'copy_url'}};var helper={addSlashes:function(str){return str.replace('\\','\\\\').replace('"','\\"').replace('\'','\\\'');},callUrlShortener:function(url){var req=new XMLHttpRequest();var service=clipboard.getUrlShortener();req.open(service.method,service.url,true);req.onreadystatechange=function(){if(req.readyState===4){var output=service.output(req.responseText);if(output){clipboard.copy(output);}else{clipboard.status=false;clipboard.showNotification();}
var popup=chrome.extension.getViews({type:'popup'})[0];popup.close();}};req.setRequestHeader('Content-Type',service.contentType);req.send(service.input(url));},countProperties:function(obj){var count=0;for(var p in obj){if(obj.hasOwnProperty(p)){count++;}}
return count;},createAnchor:function(data){if(!data.target&&utils.get('settingTargetAttr')){data.target='_blank';}
return $('<div/>').append($('<a/>',data)).html();},createBBCode:function(data){if(data.text){return'[url='+data.url+']'+data.text+'[/url]';}else{return'[url]'+data.url+'[/url]';}},createFeatureHtml:function(feature){var item=$('<li/>',{'id':feature.id+'Item','name':feature.name});var menu=$('<div/>',{'class':'menu','id':feature.id});menu.append($('<span/>',{'class':'text','id':feature.id+'Text'}));var shortcut=feature.getShortcut();if(clipboard.isThisPlatform('mac')){shortcut=feature.getMacShortcut();}
menu.append($('<span/>',{'class':'shortcut','id':feature.id+'Shortcut','text':shortcut}));item.append(menu);return $('<div/>').append(item).html();},decode:function(url){return decodeURIComponent(url);},encode:function(url){return encodeURIComponent(url);},replaceEntities:function(str){return str.replace('"','&quot;').replace('&','&amp;').replace('<','&lt;').replace('>','&gt;');}};var ietab={containerSegment:'iecontainer.html#url=',extensionId:'hehijbfgiekmjfkfjpbkbammjbdenadd',titlePrefix:'IE: ',copyAnchor:function(tab){var data={href:tab.url};if(utils.get('settingIeTabExtract')){data.href=helper.decode(ietab.extractUrl(data.href));}
data.text=tab.title||data.href;if(tab.title){if(utils.get('settingIeTabTitle')){data.text=ietab.extractTitle(data.text);}
if(utils.get('settingTitleAttr')){data.title=helper.addSlashes(data.text);}}
data.text=helper.replaceEntities(data.text);clipboard.copy(helper.createAnchor(data));},copyBBCode:function(tab){var data={text:tab.title,url:tab.url};if(utils.get('settingIeTabExtract')){data.url=helper.decode(ietab.extractUrl(data.url));}
if(data.text&&utils.get('settingIeTabTitle')){data.text=ietab.extractTitle(data.text);}
clipboard.copy(helper.createBBCode(data));},copyEncoded:function(tab){var url=tab.url;if(utils.get('settingIeTabExtract')){url=ietab.extractUrl(url);}else{url=helper.encode(url);}
clipboard.copy(url);},copyShortUrl:function(tab){var url=tab.url;if(utils.get('settingIeTabExtract')){url=helper.decode(ietab.extractUrl(url));}
helper.callUrlShortener(url);},copyUrl:function(tab){var url=tab.url;if(utils.get('settingIeTabExtract')){url=helper.decode(ietab.extractUrl(url));}
clipboard.copy(url);},extractTitle:function(str){var idx=str.indexOf(ietab.titlePrefix);if(idx!==-1){return str.substring(idx+ietab.titlePrefix.length);}
return str;},extractUrl:function(str){var idx=str.indexOf(ietab.containerSegment);if(idx!==-1){return str.substring(idx+ietab.containerSegment.length);}
return str;},isActive:function(tab){return clipboard.isSpecialPage(tab)&&tab.url.indexOf(ietab.extensionId)!==-1;}};var shortener={bitly:{contentType:'application/json',input:function(url){var data={'format':'json','longUrl':helper.encode(url)};if(utils.get('bitlyXApiKey')&&utils.get('bitlyXLogin')){data.x_apiKey=utils.get('bitlyXApiKey');data.x_login=utils.get('bitlyXLogin');}
return JSON.stringify(data);},isEnabled:function(){return utils.get('bitlyEnabled');},method:'GET',name:'bit.ly',output:function(resp){return JSON.parse(resp).data.url;},url:'http://api.bitly.com/v3/shorten?login=urlcopy&apiKey=R_05858399e8a60369e1d1562817b77b39'},google:{contentType:'application/json',input:function(url){return JSON.stringify({'longUrl':url});},isEnabled:function(){return utils.get('googleEnabled');},method:'POST',name:'goo.gl',output:function(resp){return JSON.parse(resp).id;},url:'https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyD504IwHeL3V2aw6ZGYQRgwWnJ38jNl2MY'}};